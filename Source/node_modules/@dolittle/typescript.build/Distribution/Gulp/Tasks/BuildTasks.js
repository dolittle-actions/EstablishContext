"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Dolittle. All rights reserved.
 *  Licensed under the MIT License. See LICENSE in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
const gulp_1 = __importDefault(require("gulp"));
const gulp_sourcemaps_1 = __importDefault(require("gulp-sourcemaps"));
const gulp_typescript_1 = __importDefault(require("gulp-typescript"));
const internal_1 = require("../../internal");
class BuildTasks {
    constructor(_context) {
        this._context = _context;
    }
    get buildTask() {
        if (this._buildTask === undefined) {
            this._buildTask = this.createBuildTask(true);
        }
        return this._buildTask;
    }
    get buildNoLintTask() {
        if (this._buildNoLintTask === undefined) {
            this._buildNoLintTask = this.createBuildTask(false);
        }
        return this._buildNoLintTask;
    }
    get allTasks() {
        return [this.buildTask, this.buildNoLintTask];
    }
    createBuildTask(lint) {
        let task;
        const taskSeries = [internal_1.getCleanTasks(this._context).cleanTask];
        if (lint)
            taskSeries.push(internal_1.getLintTasks(this._context).lintTask);
        if (this._context.project.workspaces.length > 0)
            taskSeries.push(this.createWorkspacesBuildTask(lint));
        else {
            const projectSources = this._context.project.sources;
            const tsProject = gulp_typescript_1.default.createProject(projectSources.tsConfig);
            const sourceFiles = projectSources.sourceFiles.sourceFileGlobs.includes.map(_ => _.absolute);
            const excludedSourceFiles = projectSources.sourceFiles.sourceFileGlobs.excludes.map(_ => _.absolute);
            const destination = projectSources.outputFiles.root;
            const taskFunction = done => {
                const tsResult = gulp_1.default.src(sourceFiles.concat(excludedSourceFiles.map(_ => '!' + _)))
                    .pipe(gulp_sourcemaps_1.default.init())
                    .pipe(tsProject());
                tsResult.dts
                    .pipe(gulp_1.default.dest(destination));
                return tsResult.js
                    .pipe(gulp_sourcemaps_1.default.write())
                    .pipe(gulp_1.default.dest(destination))
                    .on('end', _ => done())
                    .on('error', err => done(err));
            };
            taskFunction.displayName = `build${lint ? '' : '-no-lint'}:${this._context.project.rootPackage.packageObject.name}`;
            taskSeries.push(taskFunction);
        }
        taskSeries.push(this.createCopyStaticTask());
        task = gulp_1.default.series(...taskSeries);
        task.displayName = `build${lint ? '' : '-no-lint'}`;
        return task;
    }
    createWorkspacesBuildTask(lint) {
        const tasks = [];
        const streams = [];
        this._context.project.workspaces.forEach(workspace => {
            const projectSources = workspace.sources;
            const tsProject = gulp_typescript_1.default.createProject(projectSources.tsConfig);
            const sourceFiles = projectSources.sourceFiles.sourceFileGlobs.includes.map(_ => _.absolute);
            const excludedSourceFiles = projectSources.sourceFiles.sourceFileGlobs.excludes.map(_ => _.absolute);
            const destination = projectSources.outputFiles.root;
            const taskFunction = done => {
                const tsResult = gulp_1.default.src(sourceFiles.concat(excludedSourceFiles.map(_ => '!' + _)))
                    .pipe(gulp_sourcemaps_1.default.init())
                    .pipe(tsProject());
                streams.push({ stream: tsResult.js, dest: destination });
                streams.push({ stream: tsResult.dts, dest: destination });
                tsResult
                    .on('end', _ => done())
                    .on('error', err => done(err));
                return tsResult;
            };
            taskFunction.displayName = `build${lint ? '' : '-no-lint'}:${workspace.workspacePackage.packageObject.name}`;
            tasks.push(taskFunction);
        });
        const writeFilesTask = done => {
            let counter = 0;
            for (const _ of streams) {
                const stream = _.stream
                    .pipe(gulp_1.default.dest(_.dest))
                    .on('end', _ => {
                    counter += 1;
                    if (counter === streams.length)
                        done();
                })
                    .on('error', err => done(err));
            }
        };
        writeFilesTask.displayName = 'build-write-files';
        const parallelBuild = gulp_1.default.parallel(tasks);
        parallelBuild.displayName = 'build-parallel';
        const task = gulp_1.default.series(parallelBuild, writeFilesTask);
        return task;
    }
    createCopyStaticTask() {
        if (this._copyStaticTask === undefined) {
            this._copyStaticTask = internal_1.createTask(this._context, 'copy', true, workspace => {
                const usesWebPack = workspace ? workspace.workspacePackage.usesWebpack() : this._context.project.rootPackage.usesWebpack();
                if (usesWebPack)
                    return done => done();
                const projectSources = workspace !== undefined ? workspace.sources : this._context.project.sources;
                const staticFiles = projectSources.sourceFiles.staticSourceFileGlobs.includes.map(_ => _.absolute);
                const excludedStaticFiles = projectSources.sourceFiles.staticSourceFileGlobs.excludes.map(_ => _.absolute);
                const destination = projectSources.outputFiles.root;
                return done => gulp_1.default.src(staticFiles.concat(excludedStaticFiles.map(_ => '!' + _)))
                    .pipe(gulp_1.default.dest(destination))
                    .on('end', done);
            });
        }
        return this._copyStaticTask;
    }
}
exports.BuildTasks = BuildTasks;
function getBuildTasks(context) {
    if (BuildTasks.buildTasks === undefined)
        BuildTasks.buildTasks = new BuildTasks(context);
    return BuildTasks.buildTasks;
}
exports.getBuildTasks = getBuildTasks;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnVpbGRUYXNrcy5qcyIsInNvdXJjZVJvb3QiOiIuL1NvdXJjZS8iLCJzb3VyY2VzIjpbIkd1bHAvVGFza3MvQnVpbGRUYXNrcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBOzs7Z0dBR2dHO0FBQ2hHLGdEQUF3QjtBQUN4QixzRUFBNkM7QUFDN0Msc0VBQTZDO0FBRzdDLDZDQUFzRjtBQUd0RixNQUFhLFVBQVU7SUFPbkIsWUFBb0IsUUFBcUI7UUFBckIsYUFBUSxHQUFSLFFBQVEsQ0FBYTtJQUFHLENBQUM7SUFFN0MsSUFBSSxTQUFTO1FBQ1QsSUFBSSxJQUFJLENBQUMsVUFBVSxLQUFLLFNBQVMsRUFBRTtZQUMvQixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDaEQ7UUFDRCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDM0IsQ0FBQztJQUVELElBQUksZUFBZTtRQUNmLElBQUksSUFBSSxDQUFDLGdCQUFnQixLQUFLLFNBQVMsRUFBRTtZQUNyQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN2RDtRQUNELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDO0lBQ2pDLENBQUM7SUFFRCxJQUFJLFFBQVE7UUFDUixPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVPLGVBQWUsQ0FBQyxJQUFhO1FBQ2pDLElBQUksSUFBa0IsQ0FBQztRQUN2QixNQUFNLFVBQVUsR0FBRyxDQUFDLHdCQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzVELElBQUksSUFBSTtZQUFFLFVBQVUsQ0FBQyxJQUFJLENBQUMsdUJBQVksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFaEUs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Q0FBQyxDQUFDLENBQUM7cUJBQzdELElBQUksQ0FBQyxjQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO3FCQUM1QixFQUFFLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ3pDLENBQUMsQ0FBQyxDQUFDO1NBQ047UUFFRCxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUM7SUFDaEMsQ0FBQztDQUNKO0FBNUhELGdDQTRIQztBQUVELFNBQWdCLGFBQWEsQ0FBQyxPQUFvQjtJQUM5QyxJQUFJLFVBQVUsQ0FBQyxVQUFVLEtBQUssU0FBUztRQUFFLFVBQVUsQ0FBQyxVQUFVLEdBQUcsSUFBSSxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDekYsT0FBTyxVQUFVLENBQUMsVUFBVSxDQUFDO0FBQ2pDLENBQUM7QUFIRCxzQ0FHQyIsInNvdXJjZXNDb250ZW50IjpbIi8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gKiAgQ29weXJpZ2h0IChjKSBEb2xpdHRsZS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuIFNlZSBMSUNFTlNFIGluIHRoZSBwcm9qZWN0IHJvb3QgZm9yIGxpY2Vuc2UgaW5mb3JtYXRpb24uXG4gKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cbmltcG9ydCBndWxwIGZyb20gJ2d1bHAnO1xuaW1wb3J0IGd1bHBTb3VyY2VtYXBzIGZyb20gJ2d1bHAtc291cmNlbWFwcyc7XG5pbXBvcnQgZ3VscFR5cGVzY3JpcHQgZnJvbSAnZ3VscC10eXBlc2NyaXB0JztcbmltcG9ydCB7IFRhc2tGdW5jdGlvbiB9IGZyb20gJ3VuZGVydGFrZXInO1xuaW1wb3J0IHsgUmVhZGFibGUgfSBmcm9tICdzdHJlYW0nO1xuaW1wb3J0IHsgR3VscENvbnRleHQsIGdldENsZWFuVGFza3MsIGNyZWF0ZVRhc2ssIGdldExpbnRUYXNrcyB9IGZyb20gJy4uLy4uL2ludGVybmFsJztcblxuXG5leHBvcnQgY2xhc3MgQnVpbGRUYXNrcyB7XG4gICAgc3RhdGljIGJ1aWxkVGFza3M6IEJ1aWxkVGFza3M7XG5cbiAgICBwcml2YXRlIF9idWlsZFRhc2shOiBUYXNrRnVuY3Rpb247XG4gICAgcHJpdmF0ZSBfYnVpbGROb0xpbnRUYXNrITogVGFza0Z1bmN0aW9uO1xuICAgIHByaXZhdGUgX2NvcHlTdGF0aWNUYXNrITogVGFza0Z1bmN0aW9uO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfY29udGV4dDogR3VscENvbnRleHQpIHt9XG5cbiAgICBnZXQgYnVpbGRUYXNrKCkge1xuICAgICAgICBpZiAodGhpcy5fYnVpbGRUYXNrID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuX2J1aWxkVGFzayA9IHRoaXMuY3JlYXRlQnVpbGRUYXNrKHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9idWlsZFRhc2s7XG4gICAgfVxuXG4gICAgZ2V0IGJ1aWxkTm9MaW50VGFzaygpIHtcbiAgICAgICAgaWYgKHRoaXMuX2J1aWxkTm9MaW50VGFzayA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLl9idWlsZE5vTGludFRhc2sgPSB0aGlzLmNyZWF0ZUJ1aWxkVGFzayhmYWxzZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuX2J1aWxkTm9MaW50VGFzaztcbiAgICB9XG5cbiAgICBnZXQgYWxsVGFza3MoKSB7XG4gICAgICAgIHJldHVybiBbdGhpcy5idWlsZFRhc2ssIHRoaXMuYnVpbGROb0xpbnRUYXNrXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUJ1aWxkVGFzayhsaW50OiBib29sZWFuKSB7XG4gICAgICAgIGxldCB0YXNrOiBUYXNrRnVuY3Rpb247XG4gICAgICAgIGNvbnN0IHRhc2tTZXJpZXMgPSBbZ2V0Q2xlYW5UYXNrcyh0aGlzLl9jb250ZXh0KS5jbGVhblRhc2tdO1xuICAgICAgICBpZiAobGludCkgdGFza1Nlcmllcy5wdXNoKGdldExpbnRUYXNrcyh0aGlzLl9jb250ZXh0KS5saW50VGFzayk7XG5cbiAgICAgICAgaWYgKHRoaXMuX2NvbnRleHQucHJvamVjdC53b3Jrc3BhY2VzLmxlbmd0aCA+IDApIHRhc2tTZXJpZXMucHVzaCh0aGlzLmNyZWF0ZVdvcmtzcGFjZXNCdWlsZFRhc2sobGludCkpO1xuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0U291cmNlcyA9IHRoaXMuX2NvbnRleHQucHJvamVjdC5zb3VyY2VzO1xuICAgICAgICAgICAgICAgIGNvbnN0IHRzUHJvamVjdCA9IGd1bHBUeXBlc2NyaXB0LmNyZWF0ZVByb2plY3QocHJvamVjdFNvdXJjZXMudHNDb25maWchKTtcbiAgICAgICAgICAgICAgICBjb25zdCBzb3VyY2VGaWxlcyA9IHByb2plY3RTb3VyY2VzLnNvdXJjZUZpbGVzLnNvdXJjZUZpbGVHbG9icy5pbmNsdWRlcy5tYXAoXyA9PiBfLmFic29sdXRlKTtcbiAgICAgICAgICAgICAgICBjb25zdCBleGNsdWRlZFNvdXJjZUZpbGVzID0gcHJvamVjdFNvdXJjZXMuc291cmNlRmlsZXMuc291cmNlRmlsZUdsb2JzLmV4Y2x1ZGVzLm1hcChfID0+IF8uYWJzb2x1dGUpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGRlc3RpbmF0aW9uID0gcHJvamVjdFNvdXJjZXMub3V0cHV0RmlsZXMucm9vdCE7XG5cbiAgICAgICAgICAgICAgICBjb25zdCB0YXNrRnVuY3Rpb246IFRhc2tGdW5jdGlvbiA9IGRvbmUgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0c1Jlc3VsdCA9IGd1bHAuc3JjKHNvdXJjZUZpbGVzLmNvbmNhdChleGNsdWRlZFNvdXJjZUZpbGVzLm1hcChfID0+ICchJyArIF8pKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKGd1bHBTb3VyY2VtYXBzLmluaXQoKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5waXBlKHRzUHJvamVjdCgpKTtcbiAgICAgICAgICAgICAgICAgICAgdHNSZXN1bHQuZHRzXG4gICAgICAgICAgICAgICAgICAgICAgICAucGlwZShndWxwLmRlc3QoZGVzdGluYXRpb24pKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRzUmVzdWx0LmpzXG4gICAgICAgICAgICAgICAgICAgICAgICAucGlwZShndWxwU291cmNlbWFwcy53cml0ZSgpKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoZ3VscC5kZXN0KGRlc3RpbmF0aW9uKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5vbignZW5kJywgXyA9PiBkb25lKCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAub24oJ2Vycm9yJywgZXJyID0+IGRvbmUoZXJyKSk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB0YXNrRnVuY3Rpb24uZGlzcGxheU5hbWUgPSBgYnVpbGQke2xpbnQgPyAnJyA6ICctbm8tbGludCd9OiR7dGhpcy5fY29udGV4dC5wcm9qZWN0LnJvb3RQYWNrYWdlLnBhY2thZ2VPYmplY3QubmFtZX1gO1xuICAgICAgICAgICAgICAgIHRhc2tTZXJpZXMucHVzaCh0YXNrRnVuY3Rpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB0YXNrU2VyaWVzLnB1c2godGhpcy5jcmVhdGVDb3B5U3RhdGljVGFzaygpKTtcbiAgICAgICAgdGFzayA9IGd1bHAuc2VyaWVzKC4uLnRhc2tTZXJpZXMpO1xuICAgICAgICB0YXNrLmRpc3BsYXlOYW1lID0gYGJ1aWxkJHtsaW50ID8gJycgOiAnLW5vLWxpbnQnfWA7XG4gICAgICAgIHJldHVybiB0YXNrO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlV29ya3NwYWNlc0J1aWxkVGFzayhsaW50OiBib29sZWFuKSB7XG4gICAgICAgIGNvbnN0IHRhc2tzOiBUYXNrRnVuY3Rpb25bXSA9IFtdO1xuICAgICAgICBjb25zdCBzdHJlYW1zOiB7c3RyZWFtOiBSZWFkYWJsZSwgZGVzdDogc3RyaW5nfVtdID0gW107XG5cbiAgICAgICAgdGhpcy5fY29udGV4dC5wcm9qZWN0LndvcmtzcGFjZXMuZm9yRWFjaCh3b3Jrc3BhY2UgPT4ge1xuICAgICAgICAgICAgY29uc3QgcHJvamVjdFNvdXJjZXMgPSB3b3Jrc3BhY2Uuc291cmNlcztcbiAgICAgICAgICAgIGNvbnN0IHRzUHJvamVjdCA9IGd1bHBUeXBlc2NyaXB0LmNyZWF0ZVByb2plY3QocHJvamVjdFNvdXJjZXMudHNDb25maWchKTtcbiAgICAgICAgICAgIGNvbnN0IHNvdXJjZUZpbGVzID0gcHJvamVjdFNvdXJjZXMuc291cmNlRmlsZXMuc291cmNlRmlsZUdsb2JzLmluY2x1ZGVzLm1hcChfID0+IF8uYWJzb2x1dGUpO1xuICAgICAgICAgICAgY29uc3QgZXhjbHVkZWRTb3VyY2VGaWxlcyA9IHByb2plY3RTb3VyY2VzLnNvdXJjZUZpbGVzLnNvdXJjZUZpbGVHbG9icy5leGNsdWRlcy5tYXAoXyA9PiBfLmFic29sdXRlKTtcblxuICAgICAgICAgICAgY29uc3QgZGVzdGluYXRpb24gPSBwcm9qZWN0U291cmNlcy5vdXRwdXRGaWxlcy5yb290ITtcbiAgICAgICAgICAgIGNvbnN0IHRhc2tGdW5jdGlvbjogVGFza0Z1bmN0aW9uID0gZG9uZSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgdHNSZXN1bHQgPSBndWxwLnNyYyhzb3VyY2VGaWxlcy5jb25jYXQoZXhjbHVkZWRTb3VyY2VGaWxlcy5tYXAoXyA9PiAnIScgKyBfKSkpXG4gICAgICAgICAgICAgICAgICAgIC5waXBlKGd1bHBTb3VyY2VtYXBzLmluaXQoKSlcbiAgICAgICAgICAgICAgICAgICAgLnBpcGUodHNQcm9qZWN0KCkpO1xuXG4gICAgICAgICAgICAgICAgc3RyZWFtcy5wdXNoKHtzdHJlYW06IHRzUmVzdWx0LmpzLCBkZXN0OiBkZXN0aW5hdGlvbn0pO1xuICAgICAgICAgICAgICAgIHN0cmVhbXMucHVzaCh7c3RyZWFtOiB0c1Jlc3VsdC5kdHMsIGRlc3Q6IGRlc3RpbmF0aW9ufSk7XG4gICAgICAgICAgICAgICAgdHNSZXN1bHRcbiAgICAgICAgICAgICAgICAgICAgLm9uKCdlbmQnLCBfID0+IGRvbmUoKSlcbiAgICAgICAgICAgICAgICAgICAgLm9uKCdlcnJvcicsIGVyciA9PiBkb25lKGVycikpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0c1Jlc3VsdDtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0YXNrRnVuY3Rpb24uZGlzcGxheU5hbWUgPSBgYnVpbGQke2xpbnQgPyAnJyA6ICctbm8tbGludCd9OiR7d29ya3NwYWNlLndvcmtzcGFjZVBhY2thZ2UucGFja2FnZU9iamVjdC5uYW1lfWA7XG4gICAgICAgICAgICB0YXNrcy5wdXNoKHRhc2tGdW5jdGlvbik7XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCB3cml0ZUZpbGVzVGFzazogVGFza0Z1bmN0aW9uID0gZG9uZSA9PiB7XG4gICAgICAgICAgICBsZXQgY291bnRlciA9IDA7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IF8gb2Ygc3RyZWFtcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHN0cmVhbSA9IF8uc3RyZWFtXG4gICAgICAgICAgICAgICAgICAgIC5waXBlKGd1bHAuZGVzdChfLmRlc3QpKVxuICAgICAgICAgICAgICAgICAgICAub24oJ2VuZCcsIF8gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY291bnRlciArPSAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvdW50ZXIgPT09IHN0cmVhbXMubGVuZ3RoKSBkb25lKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIC5vbignZXJyb3InLCBlcnIgPT4gZG9uZShlcnIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgd3JpdGVGaWxlc1Rhc2suZGlzcGxheU5hbWUgPSAnYnVpbGQtd3JpdGUtZmlsZXMnO1xuICAgICAgICBjb25zdCBwYXJhbGxlbEJ1aWxkID0gZ3VscC5wYXJhbGxlbCh0YXNrcyk7XG4gICAgICAgIHBhcmFsbGVsQnVpbGQuZGlzcGxheU5hbWUgPSAnYnVpbGQtcGFyYWxsZWwnO1xuICAgICAgICBjb25zdCB0YXNrID0gZ3VscC5zZXJpZXMocGFyYWxsZWxCdWlsZCwgd3JpdGVGaWxlc1Rhc2spO1xuXG4gICAgICAgIHJldHVybiB0YXNrO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlQ29weVN0YXRpY1Rhc2soKSB7XG4gICAgICAgIGlmICh0aGlzLl9jb3B5U3RhdGljVGFzayA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLl9jb3B5U3RhdGljVGFzayA9IGNyZWF0ZVRhc2sodGhpcy5fY29udGV4dCwgJ2NvcHknLCB0cnVlLCAgd29ya3NwYWNlID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB1c2VzV2ViUGFjayA9IHdvcmtzcGFjZSA/IHdvcmtzcGFjZS53b3Jrc3BhY2VQYWNrYWdlLnVzZXNXZWJwYWNrKCkgOiB0aGlzLl9jb250ZXh0LnByb2plY3Qucm9vdFBhY2thZ2UudXNlc1dlYnBhY2soKTtcbiAgICAgICAgICAgICAgICBpZiAodXNlc1dlYlBhY2spIHJldHVybiBkb25lID0+IGRvbmUoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9qZWN0U291cmNlcyA9IHdvcmtzcGFjZSAhPT0gdW5kZWZpbmVkID8gd29ya3NwYWNlLnNvdXJjZXMgOiB0aGlzLl9jb250ZXh0LnByb2plY3Quc291cmNlcztcbiAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNGaWxlcyA9IHByb2plY3RTb3VyY2VzLnNvdXJjZUZpbGVzLnN0YXRpY1NvdXJjZUZpbGVHbG9icy5pbmNsdWRlcy5tYXAoXyA9PiBfLmFic29sdXRlKTtcbiAgICAgICAgICAgICAgICBjb25zdCBleGNsdWRlZFN0YXRpY0ZpbGVzID0gcHJvamVjdFNvdXJjZXMuc291cmNlRmlsZXMuc3RhdGljU291cmNlRmlsZUdsb2JzLmV4Y2x1ZGVzLm1hcChfID0+IF8uYWJzb2x1dGUpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGRlc3RpbmF0aW9uID0gcHJvamVjdFNvdXJjZXMub3V0cHV0RmlsZXMucm9vdCE7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvbmUgPT4gZ3VscC5zcmMoc3RhdGljRmlsZXMuY29uY2F0KGV4Y2x1ZGVkU3RhdGljRmlsZXMubWFwKF8gPT4gJyEnICsgXykpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnBpcGUoZ3VscC5kZXN0KGRlc3RpbmF0aW9uKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5vbignZW5kJywgZG9uZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLl9jb3B5U3RhdGljVGFzaztcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRCdWlsZFRhc2tzKGNvbnRleHQ6IEd1bHBDb250ZXh0KSB7XG4gICAgaWYgKEJ1aWxkVGFza3MuYnVpbGRUYXNrcyA9PT0gdW5kZWZpbmVkKSBCdWlsZFRhc2tzLmJ1aWxkVGFza3MgPSBuZXcgQnVpbGRUYXNrcyhjb250ZXh0KTtcbiAgICByZXR1cm4gQnVpbGRUYXNrcy5idWlsZFRhc2tzO1xufVxuIl19