"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
/*---------------------------------------------------------------------------------------------
*  Copyright (c) Dolittle. All rights reserved.
*  Licensed under the MIT License. See LICENSE in the project root for license information.
*--------------------------------------------------------------------------------------------*/
const slash_1 = __importDefault(require("slash"));
const internal_1 = require("../../internal");
class WallabySettings {
    constructor(_wallaby, _project, _setup, _settingsCallback) {
        this._wallaby = _wallaby;
        this._project = _project;
        this._setup = _setup;
        this._settingsCallback = _settingsCallback;
        this.createFiles();
        this.createTests();
        this.createCompilers();
    }
    static get INSTRUMENTED_NODE_MODULES() {
        return [
            'chai',
            'chai-as-promised',
            'sinon',
            'sinon-chai',
            '@dolittle/typescript.build'
        ];
    }
    get settings() {
        const settings = {
            files: this.files,
            tests: this.tests,
            compilers: this.compilers,
            setup: this._setup.setup,
            testFramework: 'mocha',
            env: {
                type: 'node',
                runner: 'node'
            },
        };
        if (typeof this._settingsCallback === 'function')
            this._settingsCallback(this._wallaby, settings);
        return settings;
    }
    get files() {
        if (this._files === undefined)
            this.createFiles();
        return this._files;
    }
    get tests() {
        if (this._tests === undefined)
            this.createTests();
        return this._tests;
    }
    get compilers() {
        if (this._compilers === undefined)
            this.createCompilers();
        return this._compilers;
    }
    createFiles() {
        this._files = [];
        this._files.push(...this.getBaseIgnoredFiles(), ...this.getBaseInstrumentedFiles());
        if (this._project.workspaces.length > 0) {
            this._project.workspaces.forEach(_ => this._files.push(...this.getFilesFromSources(_.sources)));
        }
        else
            this._files.push(...this.getFilesFromSources(this._project.sources));
    }
    createTests() {
        this._tests = this.getBaseIgnoredFiles();
        if (this._project.workspaces.length > 0) {
            this._project.workspaces.forEach(_ => this._tests.push(...this.getTestsFromSources(_.sources)));
        }
        else
            this._tests.push(...this.getTestsFromSources(this._project.sources));
    }
    getFilesFromSources(sources) {
        const files = [];
        const sourceRoot = this.pathAsRelativeGlobFromRoot(sources.sourceFiles.root);
        const outputRoot = this.pathAsRelativeGlobFromRoot(sources.outputFiles.root);
        files.push({ pattern: `${outputRoot}/**/*`, ignore: true });
        files.push({ pattern: `${sourceRoot}/**/for_*/**/!(given)/*.@(ts|js)`, ignore: true });
        files.push({ pattern: `${sourceRoot}/**/for_*/*.@(ts|js)`, ignore: true });
        files.push({ pattern: `${sourceRoot}/**/for_*/**/given/*.@(ts|js)`, instrument: false });
        files.push({ pattern: `${sourceRoot}/**/*.@(ts|js)` });
        return files;
    }
    getTestsFromSources(sources) {
        const files = [];
        const sourceRoot = this.pathAsRelativeGlobFromRoot(sources.sourceFiles.root);
        const outputRoot = this.pathAsRelativeGlobFromRoot(sources.outputFiles.root);
        files.push({ pattern: `${outputRoot}/**/*`, ignore: true });
        files.push({ pattern: `${sourceRoot}/**/for_*/**/given/*.@(ts|js)`, ignore: true });
        files.push({ pattern: `${sourceRoot}/**/for_*/*.@(ts|js)` });
        files.push({ pattern: `${sourceRoot}/**/for_*/**/!(given)/*.@(ts|js)` });
        return files;
    }
    createCompilers() {
        this._compilers = {
            '**/*.@(js|ts)': this._wallaby.compilers.typeScript({
                module: 'commonjs',
                downlevelIteration: true,
                allowJs: true,
                experimentalDecorators: true,
                esModuleInterop: true,
                target: 'es6'
            })
        };
    }
    getBaseInstrumentedFiles() {
        const baseFiles = [{ pattern: 'package.json', instrument: false }];
        if (this._project.workspaces.length > 0) {
            this._project.workspaces.forEach(_ => {
                const root = this.pathAsRelativeGlobFromRoot(_.sources.root);
                baseFiles.push({ pattern: `${root}/package.json`, instrument: false });
            });
        }
        return baseFiles.concat(WallabySettings.INSTRUMENTED_NODE_MODULES.map(_ => {
            return { pattern: `node_modules/${_}`, instrument: false };
        }));
    }
    getBaseIgnoredFiles() {
        const baseFiles = [];
        if (this._project.workspaces.length > 0) {
            this._project.workspaces.forEach(_ => {
                const root = this.pathAsRelativeGlobFromRoot(_.sources.root);
                baseFiles.push({ pattern: `${root}/node_modules`, ignore: true });
                if (_.workspacePackage.usesWebpack()) {
                    internal_1.SourceFiles.getWebpackSpecificExcludes(_.workspacePackage).forEach(pattern => {
                        baseFiles.push({ pattern: `${root}/${pattern}`, ignore: true });
                    });
                }
            });
        }
        else {
            const rootPackage = this._project.rootPackage;
            if (rootPackage.usesWebpack()) {
                internal_1.SourceFiles.getWebpackSpecificExcludes(rootPackage).forEach(pattern => {
                    baseFiles.push({ pattern, ignore: true });
                });
            }
        }
        const scopedPackages = WallabySettings.INSTRUMENTED_NODE_MODULES.filter(_ => _.startsWith('@'));
        const unscopedPackages = WallabySettings.INSTRUMENTED_NODE_MODULES.filter(_ => !_.startsWith('@'));
        baseFiles.push({ pattern: `node_modules/!(${unscopedPackages.join('|')})`, ignore: true });
        scopedPackages.forEach(_ => {
            const splitPackage = _.split('/');
            const scope = splitPackage[0], packageName = splitPackage[1];
            baseFiles.push({ pattern: `node_modules/${scope}/!(${packageName})`, ignore: true });
        });
        return baseFiles;
    }
    pathAsRelativeGlobFromRoot(path) {
        path = slash_1.default(path);
        const root = slash_1.default(this._project.sources.root);
        return root === path ? '.' : path.replace(`${root}/`, '');
    }
}
exports.WallabySettings = WallabySettings;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2FsbGFieVNldHRpbmdzLmpzIiwic291cmNlUm9vdCI6Ii4vU291cmNlLyIsInNvdXJjZXMiOlsiV2FsbGFieS9TZXR0aW5ncy9XYWxsYWJ5U2V0dGluZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTs7OytGQUcrRjtBQUMvRixrREFBK0I7QUFDL0IsNkNBQTZFO0FBVTdFLE1BQWEsZUFBZTtJQWlCeEIsWUFBb0IsUUFBYSxFQUFVLFFBQWlCLEVBQVUsTUFBb0IsRUFBVyxpQkFBMkM7UUFBNUgsYUFBUSxHQUFSLFFBQVEsQ0FBSztRQUFVLGFBQVEsR0FBUixRQUFRLENBQVM7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFjO1FBQVcsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUEwQjtRQUM1SSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBbkJELE1BQU0sS0FBSyx5QkFBeUI7UUFDaEMsT0FBTztZQUNILE1BQU07WUFDTixrQkFBa0I7WUFDbEIsT0FBTztZQUNQLFlBQVk7WUFDWiw0QkFBNEI7U0FDL0IsQ0FBQztJQUNOLENBQUM7SUFhRCxJQUFJLFFBQVE7UUFDUixNQUFNLFFBQVEsR0FBRztZQUNiLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztZQUNqQixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDakIsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTO1lBQ3pCLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUs7WUFFeEIsYUFBYSxFQUFFLE9BQU87WUFDdEIsR0FBRyxFQUFFO2dCQUNELElBQUksRUFBRSxNQUFNO2dCQUNaLE1BQU0sRUFBRSxNQUFNO2FBQ2pCO1NBQ0osQ0FBQztRQUNGLElBQUksT0FBTyxJQUFJLENBQUMsaUJBQWlCLEtBQU0sVUFBVTtZQUFFLElBQUksQ0FBQyxpQkFBaUIs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QUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDbkcsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRSxrQkFBa0IsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7UUFDekYsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUN2QixNQUFNLFlBQVksR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2xDLE1BQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFBRSxXQUFXLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdELFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBQyxPQUFPLEVBQUUsZ0JBQWdCLEtBQUssTUFBTSxXQUFXLEdBQUcsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQztRQUN2RixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sU0FBUyxDQUFDO0lBQ3JCLENBQUM7SUFHTywwQkFBMEIsQ0FBQyxJQUFZO1FBQzNDLElBQUksR0FBRyxlQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEIsTUFBTSxJQUFJLEdBQUcsZUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BELE9BQU8sSUFBSSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsSUFBSSxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDOUQsQ0FBQztDQUNKO0FBbEtELDBDQWtLQyIsInNvdXJjZXNDb250ZW50IjpbIi8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4qICBDb3B5cmlnaHQgKGMpIERvbGl0dGxlLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuKiAgTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLiBTZWUgTElDRU5TRSBpbiB0aGUgcHJvamVjdCByb290IGZvciBsaWNlbnNlIGluZm9ybWF0aW9uLlxuKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tKi9cbmltcG9ydCB0b1VuaXhQYXRoIGZyb20gJ3NsYXNoJztcbmltcG9ydCB7IFdhbGxhYnlTZXR1cCwgUHJvamVjdCwgU291cmNlcywgU291cmNlRmlsZXMgfSBmcm9tICcuLi8uLi9pbnRlcm5hbCc7XG5cbnR5cGUgV2FsbGFieUZpbGVQYXR0ZXJuID0gc3RyaW5nIHwge1xuICAgIHBhdHRlcm46IHN0cmluZyxcbiAgICBpbnN0cnVtZW50PzogYm9vbGVhbixcbiAgICBpZ25vcmU/OiBib29sZWFuXG59O1xuXG5leHBvcnQgdHlwZSBXYWxsYWJ5U2V0dGluZ3NDYWxsYmFjayA9ICh3YWxsYWJ5OiBhbnksIHNldHRpbmdzOiBhbnkpID0+IHZvaWQ7XG5cbmV4cG9ydCBjbGFzcyBXYWxsYWJ5U2V0dGluZ3Mge1xuXG4gICAgc3RhdGljIGdldCBJTlNUUlVNRU5URURfTk9ERV9NT0RVTEVTKCkge1xuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgJ2NoYWknLFxuICAgICAgICAgICAgJ2NoYWktYXMtcHJvbWlzZWQnLFxuICAgICAgICAgICAgJ3Npbm9uJyxcbiAgICAgICAgICAgICdzaW5vbi1jaGFpJyxcbiAgICAgICAgICAgICdAZG9saXR0bGUvdHlwZXNjcmlwdC5idWlsZCdcbiAgICAgICAgXTtcbiAgICB9XG5cbiAgICBwcml2YXRlIF9maWxlcyE6IFdhbGxhYnlGaWxlUGF0dGVybltdO1xuICAgIHByaXZhdGUgX3Rlc3RzITogV2FsbGFieUZpbGVQYXR0ZXJuW107XG4gICAgcHJpdmF0ZSBfY29tcGlsZXJzITogYW55O1xuXG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF93YWxsYWJ5OiBhbnksIHByaXZhdGUgX3Byb2plY3Q6IFByb2plY3QsIHByaXZhdGUgX3NldHVwOiBXYWxsYWJ5U2V0dXAsIHByaXZhdGUgIF9zZXR0aW5nc0NhbGxiYWNrPzogV2FsbGFieVNldHRpbmdzQ2FsbGJhY2spIHtcbiAgICAgICAgdGhpcy5jcmVhdGVGaWxlcygpO1xuICAgICAgICB0aGlzLmNyZWF0ZVRlc3RzKCk7XG4gICAgICAgIHRoaXMuY3JlYXRlQ29tcGlsZXJzKCk7XG4gICAgfVxuXG4gICAgZ2V0IHNldHRpbmdzKCkge1xuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHtcbiAgICAgICAgICAgIGZpbGVzOiB0aGlzLmZpbGVzLFxuICAgICAgICAgICAgdGVzdHM6IHRoaXMudGVzdHMsXG4gICAgICAgICAgICBjb21waWxlcnM6IHRoaXMuY29tcGlsZXJzLFxuICAgICAgICAgICAgc2V0dXA6IHRoaXMuX3NldHVwLnNldHVwLFxuXG4gICAgICAgICAgICB0ZXN0RnJhbWV3b3JrOiAnbW9jaGEnLFxuICAgICAgICAgICAgZW52OiB7XG4gICAgICAgICAgICAgICAgdHlwZTogJ25vZGUnLFxuICAgICAgICAgICAgICAgIHJ1bm5lcjogJ25vZGUnXG4gICAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3NldHRpbmdzQ2FsbGJhY2sgID09PSAnZnVuY3Rpb24nKSB0aGlzLl9zZXR0aW5nc0NhbGxiYWNrKHRoaXMuX3dhbGxhYnksIHNldHRpbmdzKTtcbiAgICAgICAgcmV0dXJuIHNldHRpbmdzO1xuICAgIH1cblxuICAgIGdldCBmaWxlcygpIHtcbiAgICAgICAgaWYgKHRoaXMuX2ZpbGVzID09PSB1bmRlZmluZWQpIHRoaXMuY3JlYXRlRmlsZXMoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbGVzO1xuICAgIH1cblxuICAgIGdldCB0ZXN0cygpIHtcbiAgICAgICAgaWYgKHRoaXMuX3Rlc3RzID09PSB1bmRlZmluZWQpIHRoaXMuY3JlYXRlVGVzdHMoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3Rlc3RzO1xuICAgIH1cblxuICAgIGdldCBjb21waWxlcnMoKSB7XG4gICAgICAgIGlmICh0aGlzLl9jb21waWxlcnMgPT09IHVuZGVmaW5lZCkgdGhpcy5jcmVhdGVDb21waWxlcnMoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbXBpbGVycztcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUZpbGVzKCkge1xuICAgICAgICB0aGlzLl9maWxlcyA9IFtdO1xuICAgICAgICB0aGlzLl9maWxlcy5wdXNoKC4uLnRoaXMuZ2V0QmFzZUlnbm9yZWRGaWxlcygpLCAuLi50aGlzLmdldEJhc2VJbnN0cnVtZW50ZWRGaWxlcygpKTtcbiAgICAgICAgaWYgKHRoaXMuX3Byb2plY3Qud29ya3NwYWNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0aGlzLl9wcm9qZWN0LndvcmtzcGFjZXMuZm9yRWFjaChfID0+IHRoaXMuX2ZpbGVzLnB1c2goLi4udGhpcy5nZXRGaWxlc0Zyb21Tb3VyY2VzKF8uc291cmNlcykpKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHRoaXMuX2ZpbGVzLnB1c2goLi4udGhpcy5nZXRGaWxlc0Zyb21Tb3VyY2VzKHRoaXMuX3Byb2plY3Quc291cmNlcykpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlVGVzdHMoKSB7XG4gICAgICAgIHRoaXMuX3Rlc3RzID0gdGhpcy5nZXRCYXNlSWdub3JlZEZpbGVzKCk7XG4gICAgICAgIGlmICh0aGlzLl9wcm9qZWN0LndvcmtzcGFjZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5fcHJvamVjdC53b3Jrc3BhY2VzLmZvckVhY2goXyA9PiB0aGlzLl90ZXN0cy5wdXNoKC4uLnRoaXMuZ2V0VGVzdHNGcm9tU291cmNlcyhfLnNvdXJjZXMpKSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB0aGlzLl90ZXN0cy5wdXNoKC4uLnRoaXMuZ2V0VGVzdHNGcm9tU291cmNlcyh0aGlzLl9wcm9qZWN0LnNvdXJjZXMpKTtcbiAgICB9XG5cblxuICAgIHByaXZhdGUgZ2V0RmlsZXNGcm9tU291cmNlcyhzb3VyY2VzOiBTb3VyY2VzKSB7XG4gICAgICAgIGNvbnN0IGZpbGVzOiBXYWxsYWJ5RmlsZVBhdHRlcm5bXSA9IFtdO1xuICAgICAgICBjb25zdCBzb3VyY2VSb290ID0gdGhpcy5wYXRoQXNSZWxhdGl2ZUdsb2JGcm9tUm9vdChzb3VyY2VzLnNvdXJjZUZpbGVzLnJvb3QpO1xuICAgICAgICBjb25zdCBvdXRwdXRSb290ID0gdGhpcy5wYXRoQXNSZWxhdGl2ZUdsb2JGcm9tUm9vdChzb3VyY2VzLm91dHB1dEZpbGVzLnJvb3QhKTtcbiAgICAgICAgZmlsZXMucHVzaCh7cGF0dGVybjogYCR7b3V0cHV0Um9vdH0vKiovKmAsIGlnbm9yZTogdHJ1ZX0pO1xuICAgICAgICBmaWxlcy5wdXNoKHtwYXR0ZXJuOiBgJHtzb3VyY2VSb290fS8qKi9mb3JfKi8qKi8hKGdpdmVuKS8qLkAodHN8anMpYCwgaWdub3JlOiB0cnVlfSk7XG4gICAgICAgIGZpbGVzLnB1c2goe3BhdHRlcm46IGAke3NvdXJjZVJvb3R9LyoqL2Zvcl8qLyouQCh0c3xqcylgLCBpZ25vcmU6IHRydWV9KTtcbiAgICAgICAgZmlsZXMucHVzaCh7cGF0dGVybjogYCR7c291cmNlUm9vdH0vKiovZm9yXyovKiovZ2l2ZW4vKi5AKHRzfGpzKWAsIGluc3RydW1lbnQ6IGZhbHNlfSk7XG4gICAgICAgIGZpbGVzLnB1c2goe3BhdHRlcm46IGAke3NvdXJjZVJvb3R9LyoqLyouQCh0c3xqcylgfSk7XG4gICAgICAgIHJldHVybiBmaWxlcztcblxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0VGVzdHNGcm9tU291cmNlcyhzb3VyY2VzOiBTb3VyY2VzKSB7XG4gICAgICAgIGNvbnN0IGZpbGVzOiBXYWxsYWJ5RmlsZVBhdHRlcm5bXSA9IFtdO1xuICAgICAgICBjb25zdCBzb3VyY2VSb290ID0gdGhpcy5wYXRoQXNSZWxhdGl2ZUdsb2JGcm9tUm9vdChzb3VyY2VzLnNvdXJjZUZpbGVzLnJvb3QpO1xuICAgICAgICBjb25zdCBvdXRwdXRSb290ID0gdGhpcy5wYXRoQXNSZWxhdGl2ZUdsb2JGcm9tUm9vdChzb3VyY2VzLm91dHB1dEZpbGVzLnJvb3QhKTtcbiAgICAgICAgZmlsZXMucHVzaCh7cGF0dGVybjogYCR7b3V0cHV0Um9vdH0vKiovKmAsIGlnbm9yZTogdHJ1ZX0pO1xuICAgICAgICBmaWxlcy5wdXNoKHtwYXR0ZXJuOiBgJHtzb3VyY2VSb290fS8qKi9mb3JfKi8qKi9naXZlbi8qLkAodHN8anMpYCwgaWdub3JlOiB0cnVlfSk7XG4gICAgICAgIGZpbGVzLnB1c2goe3BhdHRlcm46IGAke3NvdXJjZVJvb3R9LyoqL2Zvcl8qLyouQCh0c3xqcylgfSk7XG4gICAgICAgIGZpbGVzLnB1c2goe3BhdHRlcm46IGAke3NvdXJjZVJvb3R9LyoqL2Zvcl8qLyoqLyEoZ2l2ZW4pLyouQCh0c3xqcylgfSk7XG4gICAgICAgIHJldHVybiBmaWxlcztcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUNvbXBpbGVycygpIHtcbiAgICAgICAgdGhpcy5fY29tcGlsZXJzID0ge1xuICAgICAgICAgICAgJyoqLyouQChqc3x0cyknOiB0aGlzLl93YWxsYWJ5LmNvbXBpbGVycy50eXBlU2NyaXB0KHsvL1Nob3VsZCByZWFkIGFuZCBwYXJzZSB0c2NvbmZpZ1xuICAgICAgICAgICAgICAgIG1vZHVsZTogJ2NvbW1vbmpzJyxcbiAgICAgICAgICAgICAgICBkb3dubGV2ZWxJdGVyYXRpb246IHRydWUsXG4gICAgICAgICAgICAgICAgYWxsb3dKczogdHJ1ZSxcbiAgICAgICAgICAgICAgICBleHBlcmltZW50YWxEZWNvcmF0b3JzOiB0cnVlLFxuICAgICAgICAgICAgICAgIGVzTW9kdWxlSW50ZXJvcDogdHJ1ZSxcbiAgICAgICAgICAgICAgICB0YXJnZXQ6ICdlczYnXG4gICAgICAgICAgICB9KVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0QmFzZUluc3RydW1lbnRlZEZpbGVzKCkge1xuICAgICAgICBjb25zdCBiYXNlRmlsZXM6IFdhbGxhYnlGaWxlUGF0dGVybltdID0gW3sgcGF0dGVybjogJ3BhY2thZ2UuanNvbicsIGluc3RydW1lbnQ6IGZhbHNlfV07XG4gICAgICAgIGlmICh0aGlzLl9wcm9qZWN0LndvcmtzcGFjZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy5fcHJvamVjdC53b3Jrc3BhY2VzLmZvckVhY2goXyA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3Qgcm9vdCA9IHRoaXMucGF0aEFzUmVsYXRpdmVHbG9iRnJvbVJvb3QoXy5zb3VyY2VzLnJvb3QpO1xuICAgICAgICAgICAgICAgIGJhc2VGaWxlcy5wdXNoKHtwYXR0ZXJuOiBgJHtyb290fS9wYWNrYWdlLmpzb25gLCBpbnN0cnVtZW50OiBmYWxzZX0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGJhc2VGaWxlcy5jb25jYXQoV2FsbGFieVNldHRpbmdzLklOU1RSVU1FTlRFRF9OT0RFX01PRFVMRVMubWFwKF8gPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHtwYXR0ZXJuOiBgbm9kZV9tb2R1bGVzLyR7X31gLCBpbnN0cnVtZW50OiBmYWxzZX07XG4gICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEJhc2VJZ25vcmVkRmlsZXMoKSB7XG4gICAgICAgIGNvbnN0IGJhc2VGaWxlczogV2FsbGFieUZpbGVQYXR0ZXJuW10gPSBbXTtcbiAgICAgICAgaWYgKHRoaXMuX3Byb2plY3Qud29ya3NwYWNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0aGlzLl9wcm9qZWN0LndvcmtzcGFjZXMuZm9yRWFjaChfID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCByb290ID0gdGhpcy5wYXRoQXNSZWxhdGl2ZUdsb2JGcm9tUm9vdChfLnNvdXJjZXMucm9vdCk7XG4gICAgICAgICAgICAgICAgYmFzZUZpbGVzLnB1c2goe3BhdHRlcm46IGAke3Jvb3R9L25vZGVfbW9kdWxlc2AsIGlnbm9yZTogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgIGlmIChfLndvcmtzcGFjZVBhY2thZ2UudXNlc1dlYnBhY2soKSkge1xuICAgICAgICAgICAgICAgICAgICBTb3VyY2VGaWxlcy5nZXRXZWJwYWNrU3BlY2lmaWNFeGNsdWRlcyhfLndvcmtzcGFjZVBhY2thZ2UpLmZvckVhY2gocGF0dGVybiA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBiYXNlRmlsZXMucHVzaCh7cGF0dGVybjogYCR7cm9vdH0vJHtwYXR0ZXJufWAsIGlnbm9yZTogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHJvb3RQYWNrYWdlID0gdGhpcy5fcHJvamVjdC5yb290UGFja2FnZTtcbiAgICAgICAgICAgIGlmIChyb290UGFja2FnZS51c2VzV2VicGFjaygpKSB7XG4gICAgICAgICAgICAgICAgU291cmNlRmlsZXMuZ2V0V2VicGFja1NwZWNpZmljRXhjbHVkZXMocm9vdFBhY2thZ2UpLmZvckVhY2gocGF0dGVybiA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGJhc2VGaWxlcy5wdXNoKHtwYXR0ZXJuLCBpZ25vcmU6IHRydWV9KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzY29wZWRQYWNrYWdlcyA9IFdhbGxhYnlTZXR0aW5ncy5JTlNUUlVNRU5URURfTk9ERV9NT0RVTEVTLmZpbHRlcihfID0+IF8uc3RhcnRzV2l0aCgnQCcpKTtcbiAgICAgICAgY29uc3QgdW5zY29wZWRQYWNrYWdlcyA9IFdhbGxhYnlTZXR0aW5ncy5JTlNUUlVNRU5URURfTk9ERV9NT0RVTEVTLmZpbHRlcihfID0+ICFfLnN0YXJ0c1dpdGgoJ0AnKSk7XG4gICAgICAgIGJhc2VGaWxlcy5wdXNoKHtwYXR0ZXJuOiBgbm9kZV9tb2R1bGVzLyEoJHt1bnNjb3BlZFBhY2thZ2VzLmpvaW4oJ3wnKX0pYCwgaWdub3JlOiB0cnVlfSk7XG4gICAgICAgIHNjb3BlZFBhY2thZ2VzLmZvckVhY2goXyA9PiB7XG4gICAgICAgICAgICBjb25zdCBzcGxpdFBhY2thZ2UgPSBfLnNwbGl0KCcvJyk7XG4gICAgICAgICAgICBjb25zdCBzY29wZSA9IHNwbGl0UGFja2FnZVswXSwgcGFja2FnZU5hbWUgPSBzcGxpdFBhY2thZ2VbMV07XG4gICAgICAgICAgICBiYXNlRmlsZXMucHVzaCh7cGF0dGVybjogYG5vZGVfbW9kdWxlcy8ke3Njb3BlfS8hKCR7cGFja2FnZU5hbWV9KWAsIGlnbm9yZTogdHJ1ZX0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gYmFzZUZpbGVzO1xuICAgIH1cblxuXG4gICAgcHJpdmF0ZSBwYXRoQXNSZWxhdGl2ZUdsb2JGcm9tUm9vdChwYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgcGF0aCA9IHRvVW5peFBhdGgocGF0aCk7XG4gICAgICAgIGNvbnN0IHJvb3QgPSB0b1VuaXhQYXRoKHRoaXMuX3Byb2plY3Quc291cmNlcy5yb290KTtcbiAgICAgICAgcmV0dXJuIHJvb3QgPT09IHBhdGggPyAnLicgOiBwYXRoLnJlcGxhY2UoYCR7cm9vdH0vYCwgJycpO1xuICAgIH1cbn1cbiJdfQ==