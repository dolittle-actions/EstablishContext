"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
/*---------------------------------------------------------------------------------------------
*  Copyright (c) Dolittle. All rights reserved.
*  Licensed under the MIT License. See LICENSE in the project root for license information.
*--------------------------------------------------------------------------------------------*/
const path_1 = __importDefault(require("path"));
const glob_1 = __importDefault(require("glob"));
const is_glob_1 = __importDefault(require("is-glob"));
const fs_1 = __importDefault(require("fs"));
const internal_1 = require("../internal");
/**
 * Represents a project
 *
 * @export
 * @class Project
 */
class Project {
    /**
     * Instantiates an instance of {Project}.
     * @param {string} [root] The root folder of the project
     */
    constructor(root) {
        this._workspaces = [];
        this.root = root !== undefined ? path_1.default.resolve(root) : process.cwd();
        this.rootPackage = new internal_1.Package(this.root);
        this.tsLint = fs_1.default.existsSync(path_1.default.join(this.root, 'tslint.json')) ?
            path_1.default.join(this.root, 'tslint.json')
            : path_1.default.join(this.root, 'node_modules', '@dolittle', 'typescript.build', 'TSConfig', 'tslint.json');
        if (this.rootPackage.hasWorkspaces()) {
            this.createWorkspaces();
        }
        this.sources = new internal_1.Sources(this.root, this.rootPackage, this._workspaces);
    }
    /**
     * Gets the {YarnWorkspace} configuration for each yarn workspace in the project
     *
     * @readonly
     */
    get workspaces() {
        return this._workspaces;
    }
    /**
     * Whether or not this project has yarn workspaces
     *
     * @returns
     */
    hasWorkspaces() {
        return this._workspaces !== undefined && this._workspaces.length > 0;
    }
    createWorkspaces() {
        this._workspaces = [];
        const rootPackageObject = this.rootPackage.packageObject;
        rootPackageObject.workspaces.forEach(workspace => {
            if (is_glob_1.default(workspace)) {
                glob_1.default.sync(workspace, { absolute: true, }).forEach(workspacePath => {
                    try {
                        if (fs_1.default.statSync(workspacePath).isDirectory()) {
                            const workspacePackage = new internal_1.Package(workspacePath, this.rootPackage);
                            const workspaceSources = new internal_1.Sources(workspacePackage.rootFolder, workspacePackage);
                            this._workspaces.push(new internal_1.YarnWorkspace(workspacePackage, workspaceSources, this.tsLint));
                        }
                    }
                    catch (error) {
                        throw new internal_1.InvalidYarnWorkspace(workspacePath, error);
                    }
                });
            }
            else {
                try {
                    if (fs_1.default.statSync(workspace).isDirectory()) {
                        const workspacePackage = new internal_1.Package(workspace, this.rootPackage);
                        const workspaceSources = new internal_1.Sources(workspacePackage.rootFolder, workspacePackage);
                        this._workspaces.push(new internal_1.YarnWorkspace(workspacePackage, workspaceSources, this.tsLint));
                    }
                }
                catch (error) {
                    throw new internal_1.InvalidYarnWorkspace(workspace, error);
                }
            }
        });
    }
}
exports.Project = Project;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUHJvamVjdC5qcyIsInNvdXJjZVJvb3QiOiIuL1NvdXJjZS8iLCJzb3VyY2VzIjpbIlByb2plY3QvUHJvamVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBOzs7K0ZBRytGO0FBQy9GLGdEQUF3QjtBQUN4QixnREFBd0I7QUFDeEIsc0RBQTZCO0FBQzdCLDRDQUFvQjtBQUNwQiwwQ0FBb0Y7QUFFcEY7Ozs7O0dBS0c7QUFDSCxNQUFhLE9BQU87SUFJaEI7OztPQUdHO0lBQ0gsWUFBWSxJQUFhO1FBTmpCLGdCQUFXLEdBQW9CLEVBQUUsQ0FBQztRQU90QyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLGNBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNwRSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksa0JBQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDMUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxZQUFFLENBQUMsVUFBVSxDQUFDLGNBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEQsY0FBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQztZQUNuQyxDQUFDLENBQUMsY0FBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRSxXQUFXLEVBQUUsa0JBQWtCLEVBQUUsVUFBVSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRW5ILElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUUsRUFBRTtZQUNsQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztTQUMzQjtRQUVELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxrQkFBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQThCRDs7OztPQUlHO0lBQ0gsSUFBSSxVQUFVO1FBQ1YsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzVCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsYUFBYTtRQUNULE9BQU8sSUFBSSxDQUFDLFdBQVcsS0FBSyxTQUFTLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUFFTyxnQkFBZ0I7UUFDcEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDdEIsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQztRQUN6RCxpQkFBaUIsQ0FBQyxVQUFXLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxFQUFFO1lBQzlDLElBQUksaUJBQU0sQ0FBQyxTQUFTLENBQUMsRUFBRTtnQkFDbkIsY0FBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBQyxRQUFRLEVBQUUsSUFBSSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEVBQUU7b0JBQzdELElBQUk7d0JBQ0EsSUFBSSxZQUFFLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFOzRCQUMxQyxNQUFNLGdCQUFnQixHQUFHLElBQUksa0JBQU8sQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDOzRCQUN0RSxNQUFNLGdCQUFnQixHQUFHLElBQUksa0JBQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQzs0QkFDcEYsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSx3QkFBYSxDQUFDLGdCQUFnQixFQUFFLGdCQUFnQixFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO3lCQUM3RjtxQkFDSjtvQkFBQyxPQUFPLEtBQUssRUFBRTt3QkFDWixNQUFNLElBQUksK0JBQW9CLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDO3FCQUN4RDtnQkFDTCxDQUFDLENBQUMsQ0FBQzthQUNOO2lCQUNJO2dCQUNELElBQUk7b0JBQ0EsSUFBSSxZQUFFLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO3dCQUN0QyxNQUFNLGdCQUFnQixHQUFHLElBQUksa0JBQU8sQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO3dCQUNsRSxNQUFNLGdCQUFnQixHQUFHLElBQUksa0JBQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQzt3QkFDcEYsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSx3QkFBYSxDQUFDLGdCQUFnQixFQUFFLGdCQUFnQixFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO3FCQUM3RjtpQkFDSjtnQkFBQyxPQUFPLEtBQUssRUFBRTtvQkFDWixNQUFNLElBQUksK0JBQW9CLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxDQUFDO2lCQUNwRDthQUNKO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0NBQ0o7QUFsR0QsMEJBa0dDIiwic291cmNlc0NvbnRlbnQiOlsiLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiogIENvcHlyaWdodCAoYykgRG9saXR0bGUuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4qICBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuIFNlZSBMSUNFTlNFIGluIHRoZSBwcm9qZWN0IHJvb3QgZm9yIGxpY2Vuc2UgaW5mb3JtYXRpb24uXG4qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0qL1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZ2xvYiBmcm9tICdnbG9iJztcbmltcG9ydCBpc0dsb2IgZnJvbSAnaXMtZ2xvYic7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgUGFja2FnZSwgU291cmNlcywgWWFybldvcmtzcGFjZSwgSW52YWxpZFlhcm5Xb3Jrc3BhY2UgfSBmcm9tICcuLi9pbnRlcm5hbCc7XG5cbi8qKlxuICogUmVwcmVzZW50cyBhIHByb2plY3RcbiAqXG4gKiBAZXhwb3J0XG4gKiBAY2xhc3MgUHJvamVjdFxuICovXG5leHBvcnQgY2xhc3MgUHJvamVjdCB7XG5cbiAgICBwcml2YXRlIF93b3Jrc3BhY2VzOiBZYXJuV29ya3NwYWNlW10gPSBbXTtcblxuICAgIC8qKlxuICAgICAqIEluc3RhbnRpYXRlcyBhbiBpbnN0YW5jZSBvZiB7UHJvamVjdH0uXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IFtyb290XSBUaGUgcm9vdCBmb2xkZXIgb2YgdGhlIHByb2plY3RcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihyb290Pzogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMucm9vdCA9IHJvb3QgIT09IHVuZGVmaW5lZCA/IHBhdGgucmVzb2x2ZShyb290KcKgOiBwcm9jZXNzLmN3ZCgpO1xuICAgICAgICB0aGlzLnJvb3RQYWNrYWdlID0gbmV3IFBhY2thZ2UodGhpcy5yb290KTtcbiAgICAgICAgdGhpcy50c0xpbnQgPSBmcy5leGlzdHNTeW5jKHBhdGguam9pbih0aGlzLnJvb3QsICd0c2xpbnQuanNvbicpKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICBwYXRoLmpvaW4odGhpcy5yb290LCAndHNsaW50Lmpzb24nKVxuICAgICAgICAgICAgICAgICAgICAgICAgOiBwYXRoLmpvaW4odGhpcy5yb290LCAnbm9kZV9tb2R1bGVzJywgJ0Bkb2xpdHRsZScsICd0eXBlc2NyaXB0LmJ1aWxkJywgJ1RTQ29uZmlnJywgJ3RzbGludC5qc29uJyk7XG5cbiAgICAgICAgaWYgKHRoaXMucm9vdFBhY2thZ2UuaGFzV29ya3NwYWNlcygpKSB7XG4gICAgICAgICAgICB0aGlzLmNyZWF0ZVdvcmtzcGFjZXMoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc291cmNlcyA9IG5ldyBTb3VyY2VzKHRoaXMucm9vdCwgdGhpcy5yb290UGFja2FnZSwgdGhpcy5fd29ya3NwYWNlcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUgYWJzb2x1dGUgcGF0aCB0byB0aGUgcm9vdCBmb2xkZXJcbiAgICAgKlxuICAgICAqIEByZWFkb25seVxuICAgICAqL1xuICAgIHJlYWRvbmx5IHJvb3Q6IHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHJvb3Qge1BhY2thZ2V9IGZvciB0aGlzIHByb2plY3RcbiAgICAgKlxuICAgICAqIEByZWFkb25seVxuICAgICAqL1xuICAgIHJlYWRvbmx5IHJvb3RQYWNrYWdlOiBQYWNrYWdlO1xuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUge1Byb2plY3RTb3VyY2VzfSBmb3IgdGhpcyBwcm9qZWN0XG4gICAgICpcbiAgICAgKiBAcmVhZG9ubHlcbiAgICAgKi9cbiAgICByZWFkb25seSBzb3VyY2VzOiBTb3VyY2VzO1xuXG4gICAgLyoqXG4gICAgICogVGhlIGFic29sdXRlIHBhdGggdG8gdGhlIHRzbGludCBjb25maWd1cmF0aW9uIGZvciB0aGlzIHByb2plY3QuXG4gICAgICpcbiAgICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgICAqL1xuICAgIHJlYWRvbmx5IHRzTGludDogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogR2V0cyB0aGUge1lhcm5Xb3Jrc3BhY2V9IGNvbmZpZ3VyYXRpb24gZm9yIGVhY2ggeWFybiB3b3Jrc3BhY2UgaW4gdGhlIHByb2plY3RcbiAgICAgKlxuICAgICAqIEByZWFkb25seVxuICAgICAqL1xuICAgIGdldCB3b3Jrc3BhY2VzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fd29ya3NwYWNlcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXaGV0aGVyIG9yIG5vdCB0aGlzIHByb2plY3QgaGFzIHlhcm4gd29ya3NwYWNlc1xuICAgICAqXG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBoYXNXb3Jrc3BhY2VzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5fd29ya3NwYWNlcyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX3dvcmtzcGFjZXMubGVuZ3RoID4gMDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZVdvcmtzcGFjZXMoKSB7XG4gICAgICAgIHRoaXMuX3dvcmtzcGFjZXMgPSBbXTtcbiAgICAgICAgY29uc3Qgcm9vdFBhY2thZ2VPYmplY3QgPSB0aGlzLnJvb3RQYWNrYWdlLnBhY2thZ2VPYmplY3Q7XG4gICAgICAgIHJvb3RQYWNrYWdlT2JqZWN0LndvcmtzcGFjZXMhLmZvckVhY2god29ya3NwYWNlID0+IHtcbiAgICAgICAgICAgIGlmIChpc0dsb2Iod29ya3NwYWNlKSkge1xuICAgICAgICAgICAgICAgIGdsb2Iuc3luYyh3b3Jrc3BhY2UsIHthYnNvbHV0ZTogdHJ1ZSwgfSkuZm9yRWFjaCh3b3Jrc3BhY2VQYXRoID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmcy5zdGF0U3luYyh3b3Jrc3BhY2VQYXRoKS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ya3NwYWNlUGFja2FnZSA9IG5ldyBQYWNrYWdlKHdvcmtzcGFjZVBhdGgsIHRoaXMucm9vdFBhY2thZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdvcmtzcGFjZVNvdXJjZXMgPSBuZXcgU291cmNlcyh3b3Jrc3BhY2VQYWNrYWdlLnJvb3RGb2xkZXIsIHdvcmtzcGFjZVBhY2thZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3dvcmtzcGFjZXMucHVzaChuZXcgWWFybldvcmtzcGFjZSh3b3Jrc3BhY2VQYWNrYWdlLCB3b3Jrc3BhY2VTb3VyY2VzLCB0aGlzLnRzTGludCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRZYXJuV29ya3NwYWNlKHdvcmtzcGFjZVBhdGgsIGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZzLnN0YXRTeW5jKHdvcmtzcGFjZSkuaXNEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd29ya3NwYWNlUGFja2FnZSA9IG5ldyBQYWNrYWdlKHdvcmtzcGFjZSwgdGhpcy5yb290UGFja2FnZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB3b3Jrc3BhY2VTb3VyY2VzID0gbmV3IFNvdXJjZXMod29ya3NwYWNlUGFja2FnZS5yb290Rm9sZGVyLCB3b3Jrc3BhY2VQYWNrYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3dvcmtzcGFjZXMucHVzaChuZXcgWWFybldvcmtzcGFjZSh3b3Jrc3BhY2VQYWNrYWdlLCB3b3Jrc3BhY2VTb3VyY2VzLCB0aGlzLnRzTGludCkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEludmFsaWRZYXJuV29ya3NwYWNlKHdvcmtzcGFjZSwgZXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuIl19