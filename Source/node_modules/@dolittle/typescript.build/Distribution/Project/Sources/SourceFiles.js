"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
/*---------------------------------------------------------------------------------------------
*  Copyright (c) Dolittle. All rights reserved.
*  Licensed under the MIT License. See LICENSE in the project root for license information.
*--------------------------------------------------------------------------------------------*/
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
const slash_1 = __importDefault(require("slash"));
const internal_1 = require("../../internal");
/**
 * Represents the source files
 *
 * @export
 * @class SourceFiles
 */
class SourceFiles {
    /**
     * Instantiates an instance of {SourceFiles}.
     * @param {string} _projectRootFolder
     * @param {YarnWorkspace[]} [_workspaces=[]]
     */
    constructor(_projectRootFolder, _rootPackage, _workspaces = []) {
        this._projectRootFolder = _projectRootFolder;
        this._rootPackage = _rootPackage;
        this._workspaces = _workspaces;
        this._underSourceFolder = false;
        this.root = this._projectRootFolder;
        const sourceFolder = path_1.default.resolve(this._projectRootFolder, SourceFiles.FOLDER_NAME);
        if (fs_1.default.existsSync(sourceFolder) && fs_1.default.statSync(sourceFolder).isDirectory()) {
            this._underSourceFolder = true;
            this.root = sourceFolder;
        }
        this.sourceFileGlobs = this.createSourceFileGlobs(...SourceFiles.sourceFilesGlobPatterns);
        this.staticSourceFileGlobs = this.createSourceFileGlobs(...internal_1.StaticFiles.staticSourceFilesGlobPatterns);
        this.testFileGlobs = this.createSourceFileGlobs(...SourceFiles.testFilesGlobPatterns);
        this.testSetupFileGlobs = this.createSourceFileGlobs(...SourceFiles.testSetupFilesGlobPatterns);
    }
    /**
     * The name that the Source folder should have, if any
     *
     * @readonly
     * @static
     */
    static get FOLDER_NAME() { return 'Source'; }
    /**
     * The list of valid source file extensions
     *
     * @readonly
     * @static
     */
    static get FILE_EXTENSIONS() { return ['ts', 'js']; }
    /**
     * Gets the relative patterns to exclude that are specific for webpack based on the project package
     *
     * @static
     * @param {Package} rootPackage
     * @returns
     */
    static getWebpackSpecificExcludes(rootPackage) {
        const excludes = [];
        if (rootPackage.usesWebpack()) {
            const outputFolder = path_1.default.basename(require(rootPackage.webpackConfigPath)().output.path);
            excludes.push(`${outputFolder}/**/*`, ...SourceFiles.webpackSpecificPatternsToExclude);
        }
        return excludes;
    }
    createSourceFileGlobs(...globPatterns) {
        const globs = {
            includes: [],
            excludes: []
        };
        if (this._workspaces.length > 0)
            this._workspaces.forEach(_ => {
                globs.includes.push(...internal_1.createGlobPatterns(_.sources.sourceFiles.root, globPatterns, _.sources.sourceFiles.root === this._projectRootFolder ? '' : slash_1.default(_.sources.sourceFiles.root.replace(`${this._projectRootFolder}${path_1.default.sep}`, ''))));
            });
        else
            globs.includes.push(...internal_1.createGlobPatterns(this.root, globPatterns, this._underSourceFolder === true ? SourceFiles.FOLDER_NAME : undefined));
        const excludePatterns = ['node_modules/**/*', '**/node_modules/**/*', ...SourceFiles.getWebpackSpecificExcludes(this._rootPackage), ...SourceFiles.filesToIgnore];
        excludePatterns.forEach(globPattern => {
            globs.excludes.push({ relative: globPattern, absolute: internal_1.globAsAbsoluteGlob(this._projectRootFolder, globPattern) });
        });
        return globs;
    }
}
exports.SourceFiles = SourceFiles;
/**
 * The patterns to exclude that are common to webpack projects
 *
 * @static
 */
SourceFiles.webpackSpecificPatternsToExclude = [
    'Configurations/**/*', 'Scripts/**/*'
];
/**
 * The list of files that should not be considered a part of the source files
 *
 * @static
 */
SourceFiles.filesToIgnore = [
    'wallaby.config.js', 'wallaby.conf.js', 'wallaby.js', 'Gulpfile.js', 'gulpfile.js', 'webpack.config.js', 'webpack.conf.js', 'webpack.js', 'webpack.prod.config.js', 'webpack.prod.conf.js', 'webpack.prod.js',
    'mocha.options.js', 'mocha.opts.js', 'mocha.js', 'run.js', 'nginx-default.conf', 'tsconfig.json', 'tsconfig.settings.json', 'package.json', 'package-lock.json', 'yarn.lock'
];
/**
 * The list of source file glob patterns
 *
 * @static
 */
SourceFiles.sourceFilesGlobPatterns = internal_1.toPatternsThatIgnoreNodeModules(`*${internal_1.asPossibleFileExtensionsPattern(SourceFiles.FILE_EXTENSIONS)}`);
/**
 * The list of test source file glob patterns
 *
 * @static
 */
SourceFiles.testFilesGlobPatterns = [
    ...internal_1.toPatternsThatIgnoreNodeModules(`for_*/**/!(given)/*${internal_1.asPossibleFileExtensionsPattern(SourceFiles.FILE_EXTENSIONS)}`),
    ...internal_1.toPatternsThatIgnoreNodeModules(`for_*/*${internal_1.asPossibleFileExtensionsPattern(SourceFiles.FILE_EXTENSIONS)}`)
];
/**
 * The list of test setup source file glob patterns
 *
 * @static
 */
SourceFiles.testSetupFilesGlobPatterns = [
    ...internal_1.toPatternsThatIgnoreNodeModules(`for_*/**/given/**/*${internal_1.asPossibleFileExtensionsPattern(SourceFiles.FILE_EXTENSIONS)}`)
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU291cmNlRmlsZXMuanMiLCJzb3VyY2VSb290IjoiLi9Tb3VyY2UvIiwic291cmNlcyI6WyJQcm9qZWN0L1NvdXJjZXMvU291cmNlRmlsZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTs7OytGQUcrRjtBQUMvRiw0Q0FBb0I7QUFDcEIsZ0RBQXdCO0FBQ3hCLGtEQUErQjtBQUMvQiw2Q0FBc0w7QUFHdEw7Ozs7O0dBS0c7QUFDSCxNQUFhLFdBQVc7SUErRXBCOzs7O09BSUc7SUFDSCxZQUFvQixrQkFBMEIsRUFBVSxZQUFxQixFQUFVLGNBQStCLEVBQUU7UUFBcEcsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFRO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQVM7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBc0I7UUFOaEgsdUJBQWtCLEdBQVksS0FBSyxDQUFDO1FBT3hDLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDO1FBRXBDLE1BQU0sWUFBWSxHQUFHLGNBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwRixJQUFJLFlBQUUsQ0FBQyxVQUFVLENBQUMsWUFBWSxDQUFDLElBQUksWUFBRSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUN4RSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO1lBQy9CLElBQUksQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDO1NBQzVCO1FBRUQsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsR0FBRyxXQUFXLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUMxRixJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLEdBQUcsc0JBQVcsQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO1FBQ3RHLElBQUksQ0FBQyxhQUFhLEdB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QUM7QUFrQkY7Ozs7R0FJRztBQUNJLHlCQUFhLEdBQUc7SUFDbkIsbUJBQW1CLEVBQUMsaUJBQWlCLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFBRSxhQUFhLEVBQUUsbUJBQW1CLEVBQUUsaUJBQWlCLEVBQUUsWUFBWSxFQUFFLHdCQUF3QixFQUFFLHNCQUFzQixFQUFFLGlCQUFpQjtJQUM1TSxrQkFBa0IsRUFBRSxlQUFlLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxvQkFBb0IsRUFBRSxlQUFlLEVBQUUsd0JBQXdCLEVBQUUsY0FBYyxFQUFFLG1CQUFtQixFQUFFLFdBQVc7Q0FDL0ssQ0FBQztBQUVGOzs7O0dBSUc7QUFDSSxtQ0FBdUIsR0FBRywwQ0FBK0IsQ0FBQyxJQUFJLDBDQUErQixDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7QUFHckk7Ozs7R0FJRztBQUNJLGlDQUFxQixHQUFHO0lBQzNCLEdBQUcsMENBQStCLENBQUMsc0JBQXNCLDBDQUErQixDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDO0lBQ3hILEdBQUcsMENBQStCLENBQUMsVUFBVSwwQ0FBK0IsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQztDQUMvRyxDQUFDO0FBQ0Y7Ozs7R0FJRztBQUNJLHNDQUEwQixHQUFHO0lBQ2hDLEdBQUcsMENBQStCLENBQUMsc0JBQXNCLDBDQUErQixDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDO0NBQzNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuKiAgQ29weXJpZ2h0IChjKSBEb2xpdHRsZS4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiogIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4gU2VlIExJQ0VOU0UgaW4gdGhlIHByb2plY3Qgcm9vdCBmb3IgbGljZW5zZSBpbmZvcm1hdGlvbi5cbiotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSovXG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgdG9Vbml4UGF0aCBmcm9tICdzbGFzaCc7XG5pbXBvcnQgeyBZYXJuV29ya3NwYWNlLCBHbG9icywgdG9QYXR0ZXJuc1RoYXRJZ25vcmVOb2RlTW9kdWxlcywgYXNQb3NzaWJsZUZpbGVFeHRlbnNpb25zUGF0dGVybiwgY3JlYXRlR2xvYlBhdHRlcm5zLCBnbG9iQXNBYnNvbHV0ZUdsb2IsIFN0YXRpY0ZpbGVzLCBQYWNrYWdlIH0gZnJvbSAnLi4vLi4vaW50ZXJuYWwnO1xuXG5cbi8qKlxuICogUmVwcmVzZW50cyB0aGUgc291cmNlIGZpbGVzXG4gKlxuICogQGV4cG9ydFxuICogQGNsYXNzIFNvdXJjZUZpbGVzXG4gKi9cbmV4cG9ydCBjbGFzcyBTb3VyY2VGaWxlcyB7XG4gICAgLyoqXG4gICAgICogVGhlIG5hbWUgdGhhdCB0aGUgU291cmNlIGZvbGRlciBzaG91bGQgaGF2ZSwgaWYgYW55XG4gICAgICpcbiAgICAgKiBAcmVhZG9ubHlcbiAgICAgKiBAc3RhdGljXG4gICAgICovXG4gICAgc3RhdGljIGdldCBGT0xERVJfTkFNRSgpIHsgcmV0dXJuICdTb3VyY2UnOyB9XG5cbiAgICAvKipcbiAgICAgKiBUaGUgbGlzdCBvZiB2YWxpZCBzb3VyY2UgZmlsZSBleHRlbnNpb25zXG4gICAgICpcbiAgICAgKiBAcmVhZG9ubHlcbiAgICAgKiBAc3RhdGljXG4gICAgICovXG4gICAgc3RhdGljIGdldCBGSUxFX0VYVEVOU0lPTlMoKSB7IHJldHVybiBbJ3RzJywgJ2pzJ107IH1cblxuICAgIC8qKlxuICAgICAqIFRoZSBwYXR0ZXJucyB0byBleGNsdWRlIHRoYXQgYXJlIGNvbW1vbiB0byB3ZWJwYWNrIHByb2plY3RzXG4gICAgICpcbiAgICAgKiBAc3RhdGljXG4gICAgICovXG4gICAgc3RhdGljIHdlYnBhY2tTcGVjaWZpY1BhdHRlcm5zVG9FeGNsdWRlID0gW1xuICAgICAgICAnQ29uZmlndXJhdGlvbnMvKiovKicsICdTY3JpcHRzLyoqLyonXG4gICAgXTtcblxuICAgIC8qKlxuICAgICAqIEdldHMgdGhlIHJlbGF0aXZlIHBhdHRlcm5zIHRvIGV4Y2x1ZGUgdGhhdCBhcmUgc3BlY2lmaWMgZm9yIHdlYnBhY2sgYmFzZWQgb24gdGhlIHByb2plY3QgcGFja2FnZVxuICAgICAqXG4gICAgICogQHN0YXRpY1xuICAgICAqIEBwYXJhbSB7UGFja2FnZX0gcm9vdFBhY2thZ2VcbiAgICAgKiBAcmV0dXJuc1xuICAgICAqL1xuICAgIHN0YXRpYyBnZXRXZWJwYWNrU3BlY2lmaWNFeGNsdWRlcyhyb290UGFja2FnZTogUGFja2FnZSkge1xuICAgICAgICBjb25zdCBleGNsdWRlczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgaWYgKHJvb3RQYWNrYWdlLnVzZXNXZWJwYWNrKCkpIHtcbiAgICAgICAgICAgIGNvbnN0IG91dHB1dEZvbGRlciA9IHBhdGguYmFzZW5hbWUocmVxdWlyZShyb290UGFja2FnZS53ZWJwYWNrQ29uZmlnUGF0aCEpKCkub3V0cHV0LnBhdGgpO1xuICAgICAgICAgICAgZXhjbHVkZXMucHVzaChgJHtvdXRwdXRGb2xkZXJ9LyoqLypgLCAuLi5Tb3VyY2VGaWxlcy53ZWJwYWNrU3BlY2lmaWNQYXR0ZXJuc1RvRXhjbHVkZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGV4Y2x1ZGVzO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoZSBsaXN0IG9mIGZpbGVzIHRoYXQgc2hvdWxkIG5vdCBiZSBjb25zaWRlcmVkIGEgcGFydCBvZiB0aGUgc291cmNlIGZpbGVzXG4gICAgICpcbiAgICAgKiBAc3RhdGljXG4gICAgICovXG4gICAgc3RhdGljIGZpbGVzVG9JZ25vcmUgPSBbXG4gICAgICAgICd3YWxsYWJ5LmNvbmZpZy5qcycsJ3dhbGxhYnkuY29uZi5qcycsICd3YWxsYWJ5LmpzJywgJ0d1bHBmaWxlLmpzJywgJ2d1bHBmaWxlLmpzJywgJ3dlYnBhY2suY29uZmlnLmpzJywgJ3dlYnBhY2suY29uZi5qcycsICd3ZWJwYWNrLmpzJywgJ3dlYnBhY2sucHJvZC5jb25maWcuanMnLCAnd2VicGFjay5wcm9kLmNvbmYuanMnLCAnd2VicGFjay5wcm9kLmpzJyxcbiAgICAgICAgJ21vY2hhLm9wdGlvbnMuanMnLCAnbW9jaGEub3B0cy5qcycsICdtb2NoYS5qcycsICdydW4uanMnLCAnbmdpbngtZGVmYXVsdC5jb25mJywgJ3RzY29uZmlnLmpzb24nLCAndHNjb25maWcuc2V0dGluZ3MuanNvbicsICdwYWNrYWdlLmpzb24nLCAncGFja2FnZS1sb2NrLmpzb24nLCAneWFybi5sb2NrJ1xuICAgIF07XG5cbiAgICAvKipcbiAgICAgKiBUaGUgbGlzdCBvZiBzb3VyY2UgZmlsZSBnbG9iIHBhdHRlcm5zXG4gICAgICpcbiAgICAgKiBAc3RhdGljXG4gICAgICovXG4gICAgc3RhdGljIHNvdXJjZUZpbGVzR2xvYlBhdHRlcm5zID0gdG9QYXR0ZXJuc1RoYXRJZ25vcmVOb2RlTW9kdWxlcyhgKiR7YXNQb3NzaWJsZUZpbGVFeHRlbnNpb25zUGF0dGVybihTb3VyY2VGaWxlcy5GSUxFX0VYVEVOU0lPTlMpfWApO1xuXG5cbiAgICAvKipcbiAgICAgKiBUaGUgbGlzdCBvZiB0ZXN0IHNvdXJjZSBmaWxlIGdsb2IgcGF0dGVybnNcbiAgICAgKlxuICAgICAqIEBzdGF0aWNcbiAgICAgKi9cbiAgICBzdGF0aWMgdGVzdEZpbGVzR2xvYlBhdHRlcm5zID0gW1xuICAgICAgICAuLi50b1BhdHRlcm5zVGhhdElnbm9yZU5vZGVNb2R1bGVzKGBmb3JfKi8qKi8hKGdpdmVuKS8qJHthc1Bvc3NpYmxlRmlsZUV4dGVuc2lvbnNQYXR0ZXJuKFNvdXJjZUZpbGVzLkZJTEVfRVhURU5TSU9OUyl9YCksXG4gICAgICAgIC4uLnRvUGF0dGVybnNUaGF0SWdub3JlTm9kZU1vZHVsZXMoYGZvcl8qLyoke2FzUG9zc2libGVGaWxlRXh0ZW5zaW9uc1BhdHRlcm4oU291cmNlRmlsZXMuRklMRV9FWFRFTlNJT05TKX1gKVxuICAgIF07XG4gICAgLyoqXG4gICAgICogVGhlIGxpc3Qgb2YgdGVzdCBzZXR1cCBzb3VyY2UgZmlsZSBnbG9iIHBhdHRlcm5zXG4gICAgICpcbiAgICAgKiBAc3RhdGljXG4gICAgICovXG4gICAgc3RhdGljIHRlc3RTZXR1cEZpbGVzR2xvYlBhdHRlcm5zID0gW1xuICAgICAgICAuLi50b1BhdHRlcm5zVGhhdElnbm9yZU5vZGVNb2R1bGVzKGBmb3JfKi8qKi9naXZlbi8qKi8qJHthc1Bvc3NpYmxlRmlsZUV4dGVuc2lvbnNQYXR0ZXJuKFNvdXJjZUZpbGVzLkZJTEVfRVhURU5TSU9OUyl9YClcbiAgICBdO1xuXG4gICAgcHJpdmF0ZSBfdW5kZXJTb3VyY2VGb2xkZXI6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICAvKipcbiAgICAgKiBJbnN0YW50aWF0ZXMgYW4gaW5zdGFuY2Ugb2Yge1NvdXJjZUZpbGVzfS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gX3Byb2plY3RSb290Rm9sZGVyXG4gICAgICogQHBhcmFtIHtZYXJuV29ya3NwYWNlW119IFtfd29ya3NwYWNlcz1bXV1cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9wcm9qZWN0Um9vdEZvbGRlcjogc3RyaW5nLCBwcml2YXRlIF9yb290UGFja2FnZTogUGFja2FnZSwgcHJpdmF0ZSBfd29ya3NwYWNlczogWWFybldvcmtzcGFjZVtdID0gW10pIHtcbiAgICAgICAgdGhpcy5yb290ID0gdGhpcy5fcHJvamVjdFJvb3RGb2xkZXI7XG5cbiAgICAgICAgY29uc3Qgc291cmNlRm9sZGVyID0gcGF0aC5yZXNvbHZlKHRoaXMuX3Byb2plY3RSb290Rm9sZGVyLCBTb3VyY2VGaWxlcy5GT0xERVJfTkFNRSk7XG4gICAgICAgIGlmIChmcy5leGlzdHNTeW5jKHNvdXJjZUZvbGRlcikgJiYgZnMuc3RhdFN5bmMoc291cmNlRm9sZGVyKS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICB0aGlzLl91bmRlclNvdXJjZUZvbGRlciA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLnJvb3QgPSBzb3VyY2VGb2xkZXI7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnNvdXJjZUZpbGVHbG9icyA9IHRoaXMuY3JlYXRlU291cmNlRmlsZUdsb2JzKC4uLlNvdXJjZUZpbGVzLnNvdXJjZUZpbGVzR2xvYlBhdHRlcm5zKTtcbiAgICAgICAgdGhpcy5zdGF0aWNTb3VyY2VGaWxlR2xvYnMgPSB0aGlzLmNyZWF0ZVNvdXJjZUZpbGVHbG9icyguLi5TdGF0aWNGaWxlcy5zdGF0aWNTb3VyY2VGaWxlc0dsb2JQYXR0ZXJucyk7XG4gICAgICAgIHRoaXMudGVzdEZpbGVHbG9icyA9IHRoaXMuY3JlYXRlU291cmNlRmlsZUdsb2JzKC4uLlNvdXJjZUZpbGVzLnRlc3RGaWxlc0dsb2JQYXR0ZXJucyk7XG4gICAgICAgIHRoaXMudGVzdFNldHVwRmlsZUdsb2JzID0gdGhpcy5jcmVhdGVTb3VyY2VGaWxlR2xvYnMoLi4uU291cmNlRmlsZXMudGVzdFNldHVwRmlsZXNHbG9iUGF0dGVybnMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoZSByb290IGZvbGRlciBmb3IgdGhlIHNvdXJjZSBmaWxlc1xuICAgICAqXG4gICAgICogQHJlYWRvbmx5XG4gICAgICovXG4gICAgcmVhZG9ubHkgcm9vdDogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogVGhlIGdsb2JzIGZvciBhbGwgdGhlIHNvdXJjZSBmaWxlc1xuICAgICAqXG4gICAgICogQHJlYWRvbmx5XG4gICAgICovXG4gICAgcmVhZG9ubHkgc291cmNlRmlsZUdsb2JzOiBHbG9icztcblxuICAgIC8qKlxuICAgICAqIFRoZSBnbG9icyBmb3IgYWxsIHRoZSBzdGF0aWMgc291cmNlIGZpbGVzXG4gICAgICpcbiAgICAgKiBAcmVhZG9ubHlcbiAgICAgKi9cbiAgICByZWFkb25seSBzdGF0aWNTb3VyY2VGaWxlR2xvYnM6IEdsb2JzO1xuXG4gICAgLyoqXG4gICAgICogVGhlIGdsb2JzIGZvciBhbGwgdGVzdCBmaWxlc1xuICAgICAqXG4gICAgICogQHJlYWRvbmx5XG4gICAgICovXG4gICAgcmVhZG9ubHkgdGVzdEZpbGVHbG9iczogR2xvYnM7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgZ2xvYnMgZm9yIGFsbCB0aGUgdGVzdCBzZXR1cCBmaWxlc1xuICAgICAqXG4gICAgICogQHJlYWRvbmx5XG4gICAgICovXG4gICAgcmVhZG9ubHkgdGVzdFNldHVwRmlsZUdsb2JzOiBHbG9icztcblxuICAgIHByaXZhdGUgY3JlYXRlU291cmNlRmlsZUdsb2JzKC4uLmdsb2JQYXR0ZXJuczogc3RyaW5nW10pIHtcbiAgICAgICAgY29uc3QgZ2xvYnM6IEdsb2JzID0ge1xuICAgICAgICAgICAgaW5jbHVkZXM6IFtdLFxuICAgICAgICAgICAgZXhjbHVkZXM6IFtdXG4gICAgICAgIH07XG4gICAgICAgIGlmICh0aGlzLl93b3Jrc3BhY2VzLmxlbmd0aCA+IDApIHRoaXMuX3dvcmtzcGFjZXMuZm9yRWFjaChfID0+IHtcbiAgICAgICAgICAgIGdsb2JzLmluY2x1ZGVzLnB1c2goLi4uY3JlYXRlR2xvYlBhdHRlcm5zKF8uc291cmNlcy5zb3VyY2VGaWxlcy5yb290LCBnbG9iUGF0dGVybnMsIF8uc291cmNlcy5zb3VyY2VGaWxlcy5yb290ID09PSB0aGlzLl9wcm9qZWN0Um9vdEZvbGRlciA/ICcnIDogdG9Vbml4UGF0aChfLnNvdXJjZXMuc291cmNlRmlsZXMucm9vdC5yZXBsYWNlKGAke3RoaXMuX3Byb2plY3RSb290Rm9sZGVyfSR7cGF0aC5zZXB9YCwgJycpKSkpO1xuICAgICAgICB9KTtcbiAgICAgICAgZWxzZSBnbG9icy5pbmNsdWRlcy5wdXNoKC4uLmNyZWF0ZUdsb2JQYXR0ZXJucyh0aGlzLnJvb3QsIGdsb2JQYXR0ZXJucywgdGhpcy5fdW5kZXJTb3VyY2VGb2xkZXIgPT09IHRydWUgPyBTb3VyY2VGaWxlcy5GT0xERVJfTkFNRSA6IHVuZGVmaW5lZCkpO1xuXG4gICAgICAgIGNvbnN0IGV4Y2x1ZGVQYXR0ZXJucyA9IFsnbm9kZV9tb2R1bGVzLyoqLyonLCAnKiovbm9kZV9tb2R1bGVzLyoqLyonLCAuLi5Tb3VyY2VGaWxlcy5nZXRXZWJwYWNrU3BlY2lmaWNFeGNsdWRlcyh0aGlzLl9yb290UGFja2FnZSksIC4uLlNvdXJjZUZpbGVzLmZpbGVzVG9JZ25vcmVdO1xuICAgICAgICBleGNsdWRlUGF0dGVybnMuZm9yRWFjaChnbG9iUGF0dGVybiA9PiB7XG4gICAgICAgICAgICBnbG9icy5leGNsdWRlcy5wdXNoKHtyZWxhdGl2ZTogZ2xvYlBhdHRlcm4sIGFic29sdXRlOiBnbG9iQXNBYnNvbHV0ZUdsb2IodGhpcy5fcHJvamVjdFJvb3RGb2xkZXIsIGdsb2JQYXR0ZXJuKX0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGdsb2JzO1xuICAgIH1cblxufVxuIl19